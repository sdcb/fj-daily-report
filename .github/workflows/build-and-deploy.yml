name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-22.04
    outputs:
      full_ver: ${{ steps.get_version.outputs.full_ver }}
      patch_full_ver: ${{ steps.get_version.outputs.patch_full_ver }}
      minor_full_ver: ${{ steps.get_version.outputs.minor_full_ver }}
      major_ver: ${{ steps.get_version.outputs.major_ver }}
      msbuild_args: ${{ steps.get_version.outputs.msbuild_args }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ç¼“å­˜å‰ç«¯ node_modules
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: ./frontend/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      # å®‰è£…å‰ç«¯ä¾èµ–
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      # æ„å»ºå‰ç«¯
      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      # å°†å‰ç«¯æ„å»ºäº§ç‰©å¤åˆ¶åˆ°åç«¯wwwrootç›®å½•
      - name: Copy frontend build to backend
        run: |
          mkdir -p ./backend/wwwroot
          cp -r ./frontend/out/* ./backend/wwwroot/ || cp -r ./frontend/.next/standalone/* ./backend/wwwroot/ || cp -r ./frontend/dist/* ./backend/wwwroot/ || echo "Frontend build output not found in expected locations"
          ls -la ./backend/wwwroot

      # è·å–ç‰ˆæœ¬ä¿¡æ¯
      - name: Get version
        id: get_version
        run: |
          cd ./backend
          # ä»é¡¹ç›®æ–‡ä»¶è·å–ç‰ˆæœ¬ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
          ver=$(grep -oPm1 "(?<=<Version>)[^<]+" FjDailyReport.csproj || echo "1.0.0")
          minor_ver=$(echo $ver | cut -d '.' -f 1-2)
          major_ver=$(echo $ver | cut -d '.' -f 1)
          full_ver=${ver}.${{ github.run_number }}
          
          echo "full_ver=${full_ver}" >> $GITHUB_OUTPUT
          echo "patch_full_ver=${ver}" >> $GITHUB_OUTPUT
          echo "minor_full_ver=${minor_ver}" >> $GITHUB_OUTPUT
          echo "major_ver=${major_ver}" >> $GITHUB_OUTPUT
          echo "msbuild_args=/p:Version=${full_ver} /p:AssemblyVersion=${full_ver} /p:FileVersion=${full_ver} /p:InformationalVersion=${full_ver}" >> $GITHUB_OUTPUT

      # ç™»å½• GitHub Container Registry
      - name: Login to GitHub Container Registry
        run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      # ä½¿ç”¨ .NET PublishContainer æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      - name: Build and push Docker container
        run: |
          dotnet publish ./backend/FjDailyReport.csproj -c Release --os linux --arch x64 /t:PublishContainer /p:ContainerRepository=ghcr.io/${{ github.repository_owner }}/fj-daily-report ${{ steps.get_version.outputs.msbuild_args }}

      # æ ‡è®°å¹¶æ¨é€å¤šä¸ªç‰ˆæœ¬æ ‡ç­¾
      - name: Tag and push multiple versions
        run: |
          docker tag ghcr.io/${{ github.repository_owner }}/fj-daily-report:latest ghcr.io/${{ github.repository_owner }}/fj-daily-report:${{ steps.get_version.outputs.full_ver }}
          docker tag ghcr.io/${{ github.repository_owner }}/fj-daily-report:latest ghcr.io/${{ github.repository_owner }}/fj-daily-report:${{ steps.get_version.outputs.patch_full_ver }}
          docker tag ghcr.io/${{ github.repository_owner }}/fj-daily-report:latest ghcr.io/${{ github.repository_owner }}/fj-daily-report:${{ steps.get_version.outputs.minor_full_ver }}
          docker tag ghcr.io/${{ github.repository_owner }}/fj-daily-report:latest ghcr.io/${{ github.repository_owner }}/fj-daily-report:${{ steps.get_version.outputs.major_ver }}
          
          docker push ghcr.io/${{ github.repository_owner }}/fj-daily-report:${{ steps.get_version.outputs.full_ver }}
          docker push ghcr.io/${{ github.repository_owner }}/fj-daily-report:${{ steps.get_version.outputs.patch_full_ver }}
          docker push ghcr.io/${{ github.repository_owner }}/fj-daily-report:${{ steps.get_version.outputs.minor_full_ver }}
          docker push ghcr.io/${{ github.repository_owner }}/fj-daily-report:${{ steps.get_version.outputs.major_ver }}
          docker push ghcr.io/${{ github.repository_owner }}/fj-daily-report:latest

      # è¾“å‡ºéƒ¨ç½²ä¿¡æ¯
      - name: Output deployment info
        run: |
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          echo "Docker é•œåƒå·²æ¨é€åˆ° GitHub Container Registryï¼š"
          echo "  - ghcr.io/${{ github.repository_owner }}/fj-daily-report:latest"
          echo "  - ghcr.io/${{ github.repository_owner }}/fj-daily-report:${{ steps.get_version.outputs.full_ver }}"
          echo "  - ghcr.io/${{ github.repository_owner }}/fj-daily-report:${{ steps.get_version.outputs.patch_full_ver }}"
          echo "  - ghcr.io/${{ github.repository_owner }}/fj-daily-report:${{ steps.get_version.outputs.minor_full_ver }}"
          echo "  - ghcr.io/${{ github.repository_owner }}/fj-daily-report:${{ steps.get_version.outputs.major_ver }}"